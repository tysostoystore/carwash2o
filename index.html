<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Запись на автомойку</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/808/808484.png" type="image/png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- jQuery for wheel picker -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
  <!-- Simple Wheel Picker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/pearmini/SimpleWheel/dist/simple-wheel.min.css" />
  <script src="https://cdn.jsdelivr.net/gh/pearmini/SimpleWheel/dist/simple-wheel.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .animate-fade-in {
      animation: fadeInScale .36s cubic-bezier(.4,0,.2,1);
    }
    .animate-fade-out {
      animation: fadeOutScale .22s cubic-bezier(.4,0,.2,1) forwards;
    }
    @keyframes fadeInScale {
      0% { opacity: 0; transform: scale(.92); }
      100% { opacity: 1; transform: scale(1); }
    }
    @keyframes fadeOutScale {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(.96); }
    }
    .animate-slide-up {
      animation: slideUpFade .38s cubic-bezier(.4,0,.2,1);
    }
    @keyframes slideUpFade {
      0% { opacity: 0; transform: translateY(32px) scale(.98); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .btn-press {
      transition: transform .12s cubic-bezier(.4,0,.2,1), box-shadow .12s;
    }
    .btn-press:active {
      transform: scale(.96);
      box-shadow: 0 2px 10px 0 #f9731622;
    }
    .btn-pop {
      animation: btnPop .22s cubic-bezier(.4,0,.2,1);
    }
    @keyframes btnPop {
      0% { transform: scale(.85); }
      60% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }
    .fade-bg {
      background: linear-gradient(180deg, #23272f 0%, #18181b 100%);
      transition: background .4s cubic-bezier(.4,0,.2,1);
    }
    .blur-in {
      animation: blurIn .38s cubic-bezier(.4,0,.2,1);
    }
    @keyframes blurIn {
      0% { opacity: 0; filter: blur(10px); }
      100% { opacity: 1; filter: blur(0); }
    }
    .star {
      transition: transform .15s cubic-bezier(.4,0,.2,1), color .15s;
    }
    .star.animated {
      transform: scale(1.2) rotate(-6deg);
      color: #fb923c !important;
      text-shadow: 0 2px 8px #f9731644;
    }
    .btn-glow {
      box-shadow: 0 4px 24px 0 #f9731622, 0 1.5px 0 #fb923c;
      border: 1.5px solid #fb923c;
    }
    .modal-leave {
      animation: fadeOutScale .22s cubic-bezier(.4,0,.2,1) forwards;
    }
    @keyframes fadeOutScale {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(.96); }
    }
    .spinner {
      border: 2.5px solid #fff2;
      border-top: 2.5px solid #f97316;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      animation: spin .7s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin {
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center justify-center text-white">
  <div id="app"></div>
  <!-- Review Modal (hidden by default) -->
  <div id="review-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm hidden">
    <div class="bg-[#23272f] rounded-2xl shadow-xl p-6 w-full max-w-sm mx-2 flex flex-col gap-4 relative animate-fade-in">
      <button id="close-review-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
      <div class="text-xl font-bold text-white mb-2">Оставить отзыв</div>
      <textarea class="w-full rounded-lg bg-gray-900 text-white p-3 resize-none focus:outline-none focus:ring-2 focus:ring-[#f97316]" rows="4" placeholder="Ваш отзыв..."></textarea>
      <div class="flex flex-col gap-2">
        <label class="text-gray-300 text-sm font-medium">Фото (необязательно):</label>
        <input type="file" accept="image/*" class="file:bg-[#f97316] file:text-white file:rounded file:px-3 file:py-1 file:border-0 file:mr-3 text-gray-200" />
      </div>
      <div class="flex flex-col gap-2">
        <label class="text-gray-300 text-sm font-medium">Оценка:</label>
        <div id="review-stars" class="flex gap-1 text-2xl cursor-pointer">
          <span data-star="1" class="star text-gray-500 hover:text-[#f97316]">★</span>
          <span data-star="2" class="star text-gray-500 hover:text-[#f97316]">★</span>
          <span data-star="3" class="star text-gray-500 hover:text-[#f97316]">★</span>
          <span data-star="4" class="star text-gray-500 hover:text-[#f97316]">★</span>
          <span data-star="5" class="star text-gray-500 hover:text-[#f97316]">★</span>
        </div>
      </div>
      <button class="w-full mt-2 py-3 rounded-xl bg-[#f97316] text-white text-lg font-semibold shadow-sm hover:bg-[#fb923c] active:scale-95 transition" id="review-send-btn">
        <span id="review-send-text">Отправить</span>
        <span id="review-send-spinner" class="spinner hidden"></span>
      </button>
    </div>
  </div>
  <script>
    // Modal logic
    const modal = document.getElementById('review-modal');
    const closeModal = document.getElementById('close-review-modal');
    const stars = document.querySelectorAll('#review-stars .star');
    let selectedRating = 0;
    // Open modal
    document.querySelectorAll('button').forEach(btn => {
      if (btn.textContent.trim() === 'Оставить отзыв') {
        btn.addEventListener('click', () => {
          modal.classList.remove('modal-leave');
          modal.classList.remove('hidden');
        });
      }
    });
    // Close modal (with animation)
    closeModal.addEventListener('click', () => {
      modal.classList.add('modal-leave');
      setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('modal-leave'); }, 220);
    });
    // Star rating logic + animation
    stars.forEach((star, idx) => {
      star.addEventListener('mouseenter', () => {
        stars.forEach((s, i) => s.classList.toggle('text-[#f97316]', i <= idx));
        star.classList.add('animated');
      });
      star.addEventListener('mouseleave', () => {
        stars.forEach((s, i) => s.classList.toggle('text-[#f97316]', i < selectedRating));
        stars.forEach((s, i) => s.classList.toggle('text-gray-500', i >= selectedRating));
        star.classList.remove('animated');
      });
      star.addEventListener('click', () => {
        selectedRating = idx + 1;
        stars.forEach((s, i) => {
          s.classList.toggle('text-[#f97316]', i < selectedRating);
          s.classList.toggle('text-gray-500', i >= selectedRating);
          s.classList.remove('animated');
        });
        star.classList.add('animated');
        setTimeout(() => star.classList.remove('animated'), 200);
      });
    });
    // Optional: Close on outside click
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('modal-leave');
        setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('modal-leave'); }, 220);
      }
    });

    // Review send button loading state
    const reviewSendBtn = document.getElementById('review-send-btn');
    const reviewSendText = document.getElementById('review-send-text');
    const reviewSendSpinner = document.getElementById('review-send-spinner');
    reviewSendBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      reviewSendBtn.disabled = true;
      reviewSendText.classList.add('hidden');
      reviewSendSpinner.classList.remove('hidden');
      // Сбор данных
      const name = document.querySelector('#review-modal input[name="name"]')?.value || 'Гость';
      const text = document.querySelector('#review-modal textarea')?.value || '';
      const rating = selectedRating;
      const photoInput = document.querySelector('#review-modal input[type="file"]');
      let photo = '';
      // Простейший base64 encode (если фото выбрано)
      if (photoInput && photoInput.files && photoInput.files[0]) {
        const file = photoInput.files[0];
        const reader = new FileReader();
        reader.onload = async function(ev) {
          photo = ev.target.result;
          await sendReview({ name, rating, text, photo });
        };
        reader.readAsDataURL(file);
      } else {
        await sendReview({ name, rating, text, photo });
      }
    });

    async function sendReview(data) {
      const msg = document.getElementById('review-msg') || document.createElement('div');
      msg.id = 'review-msg';
      msg.className = 'text-center text-sm mt-2';
      reviewSendBtn.parentNode.insertBefore(msg, reviewSendBtn.nextSibling);
      if (!data.rating) {
        msg.textContent = 'Поставьте оценку';
        msg.className = 'text-red-400 text-center mt-2';
        reviewSendBtn.disabled = false;
        reviewSendText.classList.remove('hidden');
        reviewSendSpinner.classList.add('hidden');
        return;
      }
      try {
        const res = await fetch('https://carwash2o.fly.dev/reviews', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          msg.textContent = 'Спасибо за отзыв!';
          msg.className = 'text-green-400 text-center mt-2';
          // Если 5 звёзд — показать модалку с просьбой оставить отзыв на 2ГИС
          if (data.rating === 5) {
            setTimeout(() => {
              show2GISModal();
              msg.textContent = '';
            }, 1200);
          } else {
            setTimeout(() => {
              modal.classList.add('modal-leave');
              setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('modal-leave'); }, 220);
              msg.textContent = '';
            }, 1200);
          }
        } else {
          msg.textContent = result.error || 'Ошибка отправки';
          msg.className = 'text-red-400 text-center mt-2';
        }
      } catch {
        msg.textContent = 'Ошибка сервера';
        msg.className = 'text-red-400 text-center mt-2';
      }
      reviewSendBtn.disabled = false;
      reviewSendText.classList.remove('hidden');
      reviewSendSpinner.classList.add('hidden');
    }

    // Модалка для 2ГИС
    function show2GISModal() {
      // Создать модалку, если её нет
      let modal2gis = document.getElementById('gis-modal');
      if (!modal2gis) {
        modal2gis = document.createElement('div');
        modal2gis.id = 'gis-modal';
        modal2gis.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm';
        modal2gis.innerHTML = `
          <div class="bg-[#23272f] rounded-2xl shadow-xl p-7 w-full max-w-xs flex flex-col gap-4 relative animate-fade-in border border-[#f97316]/30">
            <button id="close-gis-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            <div class="text-xl font-bold text-white mb-2 text-center">Спасибо за 5 звёзд!</div>
            <div class="text-gray-300 text-center mb-2">Пожалуйста, поддержите нас отзывом на 2ГИС — это очень важно для нас!</div>
            <a href="https://2gis.ru/spb/branches/70000001006983509/firm/70000001046321158/30.352404%2C59.873384/tab/reviews/addreview" target="_blank" rel="noopener noreferrer" class="w-full py-3 rounded-xl bg-[#f97316] text-white text-lg font-semibold shadow-sm hover:bg-[#fb923c] active:scale-95 transition text-center block">Оставить отзыв на 2ГИС</a>
          </div>
        `;
        document.body.appendChild(modal2gis);
      } else {
        modal2gis.classList.remove('hidden');
      }
      // Закрытие модалки
      document.getElementById('close-gis-modal').onclick = () => {
        modal2gis.classList.add('hidden');
        // Закрыть и review modal тоже, если вдруг открыт
        const modal = document.getElementById('review-modal');
        modal.classList.add('modal-leave');
        setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('modal-leave'); }, 220);
      };
      // Клик вне окна — тоже закрыть
      modal2gis.onclick = (e) => {
        if (e.target === modal2gis) {
          modal2gis.classList.add('hidden');
          const modal = document.getElementById('review-modal');
          modal.classList.add('modal-leave');
          setTimeout(() => { modal.classList.add('hidden'); modal.classList.remove('modal-leave'); }, 220);
        }
      };
    }
  </script>


  <script src="config.js"></script>
  <script src="main.js"></script>
</body>
</html>
